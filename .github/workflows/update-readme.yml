name: Update README with Blog Info

on:
  issues:
    types: [opened, edited, deleted, closed, reopened]
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *' # æ¯å¤© UTC 0ç‚¹è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch Issues and Generate Content
        uses: actions/github-script@v6
        id: blog_data
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // è·å–æ‰€æœ‰é PR çš„ Issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              creator: owner,
              state: 'open'
            });
            
            const posts = issues.filter(i => !i.pull_request);
            const count = posts.length;
            const lastUpdate = count > 0 ? posts[0].created_at.split('T')[0] : 'N/A';
            
            // æ„å»º README å†…å®¹
            const content = `
            <div align="center">
              <img src="https://avatars.githubusercontent.com/u/64282354?v=4" width="100" style="border-radius:50%">
              <h1>Hex Blog</h1>
              <p><b>æ˜¯ç”Ÿæ´»ç©å¼„äº†ä½ ï¼Œè¿˜æ˜¯ä½ äº«å—äº†ç”Ÿæ´»ï¼</b></p>
              <p>ğŸ“ æ–‡ç« ç¯‡æ•°ï¼š<b>${count}</b> &nbsp;&nbsp; ğŸ“… æœ€è¿‘æ›´æ–°ï¼š<b>${lastUpdate}</b></p>
            </div>
            
            ---
            `;
            
            const fs = require('fs');
            const readme = fs.readFileSync('README.md', 'utf8');
            const newReadme = readme.replace(
              /[\s\S]*/,
              `\n${content}\n`
            );
            fs.writeFileSync('README.md', newReadme);

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: update blog stats in README" || exit 0
          git push
