name: Update Blog Stats and Backup Articles

on:
  issues:
    types: [opened, edited, deleted, closed, reopened]
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'backup/**'
  schedule:
    - cron: '0 0 * * *' # æ¯å¤© UTC 0ç‚¹è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-and-backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ç¡®ä¿ push é¡ºç•…

      # --- æ­¥éª¤ 1: å¤‡ä»½æ–‡ç«  ---
      - name: Fetch All Issues and Backup
        run: |
          mkdir -p backup
          # è·å–æ‰€æœ‰é PR çš„ Issue å¹¶ç”Ÿæˆ MD æ–‡ä»¶
          curl -s "https://api.github.com/repos/${{ github.repository }}/issues?state=all&per_page=100" | jq -c '.[]' | while read -r issue; do
            if echo "$issue" | jq -e '.pull_request' > /dev/null; then
                continue
            fi
            TITLE=$(echo "$issue" | jq -r '.title' | sed 's/[/\\:?*"<>|]/-/g')
            BODY=$(echo "$issue" | jq -r '.body')
            if [ "$BODY" != "null" ]; then
              echo "$BODY" > "backup/${TITLE}.md"
            fi
          done

      # --- æ­¥éª¤ 2: æ›´æ–° README ç»Ÿè®¡ (JavaScript) ---
      - name: Update README Content
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              creator: owner,
              state: 'open'
            });
            
            const posts = issues.filter(i => !i.pull_request);
            const count = posts.length;
            const lastUpdate = count > 0 ? posts[0].created_at.split('T')[0] : 'N/A';
            
            const content = `
            <div align="center">
              <img src="https://avatars.githubusercontent.com/u/64282354?v=4" width="100" style="border-radius:50%">
              <h1>Hex Blog</h1>
              <p><b>æ˜¯ç”Ÿæ´»ç©å¼„äº†ä½ ï¼Œè¿˜æ˜¯ä½ äº«å—äº†ç”Ÿæ´»ï¼</b></p>
              <p>ğŸ“ æ–‡ç« ç¯‡æ•°ï¼š<b>${count}</b> &nbsp;&nbsp; ğŸ“… æœ€è¿‘æ›´æ–°ï¼š<b>${lastUpdate}</b></p>
            </div>
            
            ---
            `;
            
            const readme = fs.readFileSync('README.md', 'utf8');
            // æ›¿æ¢ç­–ç•¥ï¼šè¿™é‡Œå‡è®¾ä½ å¸Œæœ› content æ”¾åœ¨æ–‡ä»¶å¼€å¤´
            // å¦‚æœä½ æœ‰ç‰¹å®šçš„æ ‡è®°ä½ï¼Œå¯ä»¥è°ƒæ•´è¿™é‡Œçš„æ­£åˆ™
            const newReadme = readme.replace(/[\s\S]*?(?=---|$)/, `\n${content}\n`);
            fs.writeFileSync('README.md', newReadme);

      # --- æ­¥éª¤ 3: ç»Ÿä¸€æäº¤å¹¶æ¨é€ ---
      - name: Commit and Push
        run: |
          git config --global core.quotepath false
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add README.md backup/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å˜åŠ¨ï¼ˆåŒ…æ‹¬ README å’Œå¤‡ä»½æ–‡ä»¶ï¼‰
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•å†…å®¹å˜åŒ–ï¼Œè·³è¿‡æ¨é€ã€‚"
          else
            git commit -m "chore: automated backup and readme update [skip ci]"
            # å³ä½¿åˆå¹¶äº†ï¼ŒåŠ ä¸Š rebase ä¹Ÿæ˜¯åŒé‡ä¿é™©
            git pull --rebase origin main
            git push origin main
          fi
