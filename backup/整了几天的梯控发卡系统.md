### åˆè¡· 
è™½è¯´è¿™æ ·ç³»ç»Ÿæ²¡ä»€ä¹ˆç ”ç©¶ä»·å€¼äº†ï¼Œä½†æ˜¯æˆ‘è¿™é‡Œé‡åˆ°ä¸€ä¸ªå·®ç‚¹å°±è§£ä¸å¼€å¡äº†ã€‚å¥½åœ¨æœ‰æƒŠæ— é™©çš„è§£å¼€äº† 
ç³»ç»Ÿä¸ºäº’è”åˆ›ï¼Œæ²¡å¼€å¯æ»šåŠ¨ä½ ï¼Œä¸€å¡ä¸€å¯†çš„ç³»ç»Ÿ ï¼Œä¹Ÿå¯ä»¥åˆå§‹æ»šåŠ¨ä½ã€‚
é—®åˆ«é—®è¦äº†ä¸ªå¯†é’¥è®¡ç®—è½¯ä»¶ï¼Œå¥½åœ¨è¿˜æœ‰ä¸ªç®—æ³•è¡¨ ï¼ŒåŸºäºè¿™ä¸ªç®—æ³•è¡¨ ä½¿ç”¨python æ•´å‡ºäº†è½¯ä»¶ï¼Œ
### å¥‡æ€ªçš„BUG 
è™½ç„¶æå‡ºæ¥äº†ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†è¿˜æ˜¯ç®—çš„å¯¹ ï¼Œåªæ˜¯æœ‰çš„ç‰¹æ®Šå­—èŠ‚å¯†é’¥ä¼šç®—é”™ï¼Œæä¸æ‡‚ å‹‰å¼ºè¿™æ ·ç”¨å§ï¼
è¿˜è·Ÿæ®ç®—æ³•æ·»åŠ äº†åæ¨å›­åŒºç åŠŸèƒ½ã€‚å’±ä¹Ÿæ²¡éªŒè¯è¿™ä¸ªåŠŸèƒ½å‡†ç¡®ä¸å‡†ç¡®ï¼Œä½†æ˜¯åŸºäºæ ·æœ¬åæ¨å‡ºæ¥çš„åŸºæœ¬æ˜¯å‡†ç¡®çš„ï¼Œæœ‰å¾…éªŒè¯ã€‚
### è´´å‡ºä»£ç ä½œä¸ºå¤‡ä»½ï¼
åç»­å¦‚æœç®—æ³•å®Œå–„äº†ï¼Œåç»­åŸºäºæœ¬ä»£ç ç»§ç»­æ·»åŠ ä¼˜åŒ–ï¼
~~~
import tkinter as tk
from tkinter import messagebox, ttk
import re

class ProfessionalCardToolV7:
    def __init__(self, root):
        self.root = root
        self.root.title("äº’è”åˆ›å¯†é’¥è®¡ç®— - ä¸‰é‡ç¢°æ’æ·±åº¦åˆ†æç‰ˆ")
        self.root.geometry("700x880")
        self.root.configure(bg="#f8f9fa") 
        
        # æ ¸å¿ƒé€»è¾‘æ˜ å°„
        self.MAP_P1 = {'0':'B','1':'C','2':'D','3':'E','4':'B','5':'C','6':'D','7':'E','8':'3','9':'4','A':'5','B':'6','C':'3','D':'4','E':'5','F':'6'}
        self.MAP_P3 = {
            '0':('A','B'), '1':('A','B'), '2':('C','D'), '3':('C','D'),
            '4':('A','B'), '5':('A','B'), '6':('C','D'), '7':('C','D'),
            '8':('2','3'), '9':('2','3'), 'A':('4','5'), 'B':('4','5'),
            'C':('2','3'), 'D':('2','3'), 'E':('4','5'), 'F':('4','5')
        }
        self.MAP_P4 = {'0':'E','1':'E','2':'0','3':'0','4':'2','5':'2','6':'4','7':'4','8':'6','9':'6','A':'8','B':'8','C':'A','D':'A','E':'C','F':'C'}

        self.apply_styles()
        self.setup_ui()

    def apply_styles(self):
        style = ttk.Style()
        style.theme_use('clam')
        style.configure("TNotebook", background="#f8f9fa", borderwidth=0)
        style.configure("TNotebook.Tab", padding=[15, 8], font=('å¾®è½¯é›…é»‘', 10))
        style.map("TNotebook.Tab", background=[("selected", "#2196F3")], foreground=[("selected", "white")])

    def clean_hex(self, text):
        return re.sub(r'[^0-9A-Fa-f]', '', text).upper()

    def copy_to_clipboard(self, content, mode="KEY"):
        self.root.clipboard_clear()
        self.root.clipboard_append(content)
        self.root.update()
        msg = f"æˆåŠŸï¼šå·²å¤åˆ¶å¯†é’¥ [{content}]" if mode=="KEY" else f"æˆåŠŸï¼šå·²å¤åˆ¶å›­åŒºç  [{content}]"
        self.lbl_status.config(text=msg, fg="#2ecc71", font=('å¾®è½¯é›…é»‘', 9, 'bold'))

    def setup_ui(self):
        header = tk.Frame(self.root, bg="#2c3e50", height=60)
        header.pack(fill='x')
        tk.Label(header, text="äº’è”åˆ›å¯†é’¥ç®—æ³•åˆ†æç³»ç»Ÿ", fg="white", bg="#2c3e50", font=('å¾®è½¯é›…é»‘', 14, 'bold')).pack(pady=15)

        notebook = ttk.Notebook(self.root)
        notebook.pack(expand=True, fill='both', padx=15, pady=10)

        # --- æ­£å‘è®¡ç®—é¢æ¿ ---
        fwd_frame = tk.Frame(notebook, bg="white")
        notebook.add(fwd_frame, text=" ğŸ”’ å¯†é’¥ç”Ÿæˆ ")
        
        self.create_input_section(fwd_frame, "8ä½åŸå§‹å¡å· (Card Hex):", "", "ent_card")
        self.create_input_section(fwd_frame, "8ä½å›­åŒºä»£ç  (Park Code):", "", "ent_park")

        btn_fwd = tk.Button(fwd_frame, text="ç”Ÿæˆå¹¶å¤åˆ¶å¯†é’¥ B", command=self.calc_forward, 
                           bg="#2196F3", fg="white", font=('å¾®è½¯é›…é»‘', 11, 'bold'), 
                           relief='flat', cursor='hand2', pady=10)
        btn_fwd.pack(fill='x', padx=40, pady=20)

        self.txt_fwd_res = tk.Text(fwd_frame, height=2, font=('Consolas', 16, 'bold'), 
                                  bg="#f1f2f6", fg="#2c3e50", bd=0, padx=15, pady=10)
        self.txt_fwd_res.pack(padx=40, pady=5)

        # --- é€†å‘åˆ†æé¢æ¿ (å¤šç»„ç¢°æ’ç‰ˆ) ---
        rev_frame = tk.Frame(notebook, bg="white")
        notebook.add(rev_frame, text=" ğŸ”“ é€†å‘åˆ†æ (ä¸‰é‡ç¢°æ’) ")

        # æ ·æœ¬ 1
        s1_labelframe = tk.LabelFrame(rev_frame, text=" æ•°æ®æ ·æœ¬ 1 ", bg="white", fg="#2196F3")
        s1_labelframe.pack(fill='x', padx=20, pady=5)
        self.ent_rev_c1 = self.create_rev_entry(s1_labelframe, "å¡å· 1:")
        self.ent_rev_k1 = self.create_rev_entry(s1_labelframe, "å¯†é’¥ 1:")

        # æ ·æœ¬ 2
        s2_labelframe = tk.LabelFrame(rev_frame, text=" æ•°æ®æ ·æœ¬ 2 ", bg="white", fg="#2196F3")
        s2_labelframe.pack(fill='x', padx=20, pady=5)
        self.ent_rev_c2 = self.create_rev_entry(s2_labelframe, "å¡å· 2:")
        self.ent_rev_k2 = self.create_rev_entry(s2_labelframe, "å¯†é’¥ 2:")

        # æ ·æœ¬ 3
        s3_labelframe = tk.LabelFrame(rev_frame, text=" æ•°æ®æ ·æœ¬ 3 ", bg="white", fg="#2196F3")
        s3_labelframe.pack(fill='x', padx=20, pady=5)
        self.ent_rev_c3 = self.create_rev_entry(s3_labelframe, "å¡å· 3:")
        self.ent_rev_k3 = self.create_rev_entry(s3_labelframe, "å¯†é’¥ 3:")

        btn_rev = tk.Button(rev_frame, text="æ‰§è¡Œä¸‰é‡é€»è¾‘ç¢°æ’åˆ†æ", command=self.calc_backward, 
                           bg="#e67e22", fg="white", font=('å¾®è½¯é›…é»‘', 11, 'bold'), 
                           relief='flat', cursor='hand2', pady=10)
        btn_rev.pack(fill='x', padx=40, pady=15)

        self.txt_rev_res = tk.Text(rev_frame, height=12, font=('Consolas', 9), 
                                  bg="#2d3436", fg="#dfe6e9", bd=0, padx=15, pady=10)
        self.txt_rev_res.pack(padx=20, pady=5, fill='both')

        self.lbl_status = tk.Label(self.root, text="ç³»ç»Ÿå°±ç»ª | å¤šç»„è¾“å…¥å¯æ¶ˆé™¤åæ¨è¯¯å·®", bd=0, bg="#ecf0f1", fg="#95a5a6", anchor=tk.W, padx=10, pady=5)
        self.lbl_status.pack(side=tk.BOTTOM, fill=tk.X)

    def create_rev_entry(self, parent, label_text):
        frame = tk.Frame(parent, bg="white")
        frame.pack(fill='x', padx=10, pady=2)
        tk.Label(frame, text=label_text, bg="white", width=8, anchor='w').pack(side='left')
        entry = tk.Entry(frame, font=('Consolas', 10), bg="#f8f9fa", bd=1)
        entry.pack(side='left', fill='x', expand=True)
        return entry

    def create_input_section(self, parent, label_text, default_val, attr_name):
        frame = tk.Frame(parent, bg="white")
        frame.pack(fill='x', padx=40, pady=10)
        tk.Label(frame, text=label_text, bg="white", fg="#34495e", font=('å¾®è½¯é›…é»‘', 9, 'bold')).pack(anchor='w')
        entry = tk.Entry(frame, font=('Consolas', 12), bg="#ffffff", highlightthickness=1, bd=0)
        entry.insert(0, default_val)
        entry.pack(fill='x', ipady=8, pady=5)
        setattr(self, attr_name, entry)

    def calc_forward(self):
        try:
            c, p = self.clean_hex(self.ent_card.get()), self.clean_hex(self.ent_park.get())
            if len(c) != 8 or len(p) != 8: raise ValueError("è¯·è¾“å…¥å®Œæ•´çš„ 8 ä½åå…­è¿›åˆ¶æ•°æ®")
            p3_idx = 1 if c[3] not in ['0', '1'] else 0
            pre = f"{self.MAP_P1[c[0]]}0{self.MAP_P3[c[2]][p3_idx]}{self.MAP_P4[c[3]]}"
            cb, pb = [int(c[i:i+2], 16) for i in range(0, 8, 2)], [int(p[i:i+2], 16) for i in range(0, 8, 2)]
            b3, b4, b5, b6 = (cb[0]|pb[0])+(cb[2]&pb[0]), (cb[1]|pb[1])+(cb[3]&pb[1]), (cb[2]|pb[2]), (cb[3]|pb[3])
            res_str = f"{pre}{b3:02X}{b4:02X}{b5:02X}{b6:02X}"
            self.txt_fwd_res.delete('1.0', tk.END)
            self.txt_fwd_res.insert(tk.END, " ".join([res_str[i:i+2] for i in range(0, 12, 2)]))
            self.copy_to_clipboard(res_str, "KEY")
        except Exception as e:
            self.lbl_status.config(text=f"é”™è¯¯ï¼š{str(e)}", fg="#e74c3c")

    def calc_backward(self):
        try:
            # æå–ä¸‰ç»„æ ·æœ¬
            samples = [
                (self.clean_hex(self.ent_rev_c1.get()), self.clean_hex(self.ent_rev_k1.get())),
                (self.clean_hex(self.ent_rev_c2.get()), self.clean_hex(self.ent_rev_k2.get())),
                (self.clean_hex(self.ent_rev_c3.get()), self.clean_hex(self.ent_rev_k3.get()))
            ]
            
            # è¿‡æ»¤æ‰ç©ºæ ·æœ¬
            active_samples = [s for s in samples if s[0] and s[1]]
            if not active_samples: raise ValueError("è¯·è‡³å°‘è¾“å…¥ä¸€ç»„å®Œæ•´çš„å¡å·å’Œå¯†é’¥")

            def find_p_candidates(cb, kb, f_type, target):
                matches = set()
                for p in range(256):
                    if f_type==1: v = (cb[0]|p)+(cb[2]&p)
                    elif f_type==2: v = (cb[1]|p)+(cb[3]&p)
                    elif f_type==3: v = (cb[2]|p)
                    elif f_type==4: v = (cb[3]|p)
                    if (v & 0xFF) == target:
                        p_str = f"{p:02X}"
                        if p_str.isdigit(): matches.add(p_str) # é”å®šçº¯æ•°å­—å›­åŒºç 
                return matches

            final_park_bytes = []
            report = f" [ TRIPLE COLLISION REPORT ]\n{'-'*40}\n"

            for byte_pos in range(4): # P1, P2, P3, P4
                all_candidates = []
                for c_hex, k_hex in active_samples:
                    cb = [int(c_hex[i:i+2], 16) for i in range(0, 8, 2)]
                    kb = [int(k_hex[i:i+2], 16) for i in range(0, 12, 2)]
                    # å¯†é’¥çš„å4ä¸ªå­—èŠ‚å¯¹åº” kb[2] åˆ° kb[5]
                    all_candidates.append(find_p_candidates(cb, kb, byte_pos+1, kb[byte_pos+2]))

                # äº¤å‰ç¢°æ’ï¼šå–æ‰€æœ‰æ ·æœ¬å€™é€‰é›†çš„äº¤é›†
                intersect = set.intersection(*all_candidates) if all_candidates else set()
                
                if intersect:
                    # å¦‚æœæœ‰å¤šä¸ªæ•°å­—è§£ï¼Œå–æ•°å€¼æœ€å°çš„ï¼ˆé€šå¸¸åªæœ‰ä¸€ä¸ªè§£ï¼‰
                    chosen = sorted(list(intersect))[0]
                    final_park_bytes.append(chosen)
                    report += f" P{byte_pos+1} æˆåŠŸé”å®š: {chosen} (å€™é€‰: {list(intersect)})\n"
                else:
                    # å®¹é”™å¤„ç†
                    report += f" P{byte_pos+1} ç¢°æ’å¤±è´¥! (äº¤é›†ä¸ºç©º)\n"
                    final_park_bytes.append("??")

            recommend = "".join(final_park_bytes)
            report += f"{'-'*40}\n >>> æ¨å®šå›­åŒºç : {recommend}\n"
            
            self.txt_rev_res.delete('1.0', tk.END)
            self.txt_rev_res.insert(tk.END, report)
            if "??" not in recommend:
                self.copy_to_clipboard(recommend, "PARK")
        except Exception as e:
            self.lbl_status.config(text=f"é”™è¯¯ï¼š{str(e)}", fg="#e74c3c")

if __name__ == "__main__":
    root = tk.Tk()
    app = ProfessionalCardToolV7(root)
    root.mainloop()

~~~
